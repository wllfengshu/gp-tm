<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>租户控制台</title>
		<meta name="author" content="WLL">
		<% include ./components/scriptCSS.html %>
		<% include ./components/scriptJS.html %>
		<!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<!-- The fav icon -->
		<link rel="shortcut icon" href="../img/favicon.ico">
	</head>

	<body>
		<style>
			html {
				overflow-x: hidden;
				overflow-y: auto;
			}
		</style>
		<% include ./components/topBar.html %>
		<div class="ch-container">
			<div class="row">
				<% include ./components/leftMenu.html %>
				<% include ./components/noScript.html %>
				<div id="havaTable" class="col-lg-10 col-sm-10">
					<div>
						<!-- content starts -->
						<div>
							<ul class="breadcrumb">
								<li>
									<a href="index">主页</a>
								</li>
								<li>
									<a href="#">用户管理</a>
								</li>
								<li>
									<a href="userInfo">用户信息管理</a>
								</li>
							</ul>
							<a  @click="addBut"  class="label-success label label-default btn-setting_addUser" style="font-size:14px">添加用户</a>
							<!--下面的div是弹框  -->
							<div class="modal fade" id="myModal_addUser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal">×</button>
											<h3>添加用户：</h3>
										</div>
										<div class="modal-body" style="height: 420px;">
											<div class="form-group has-success col-md-12">
												<label class="control-label" for="">姓名：</label>
												<input type="text" placeholder="请输入姓名" class="form-control" id="_login_name">
											</div>
											<div class="form-group has-success col-md-12">
												<label class="control-label" for="">工号：</label>
												<input type="number" placeholder="请输入工号" class="form-control" id="_username">
											</div>
											<div class="form-group has-success col-md-12">
												<label class="control-label" for="">手机号：</label>
												<input type="number" placeholder="请输入手机号" class="form-control" id="_phone">
											</div>
											<div class="form-group has-success col-md-12">
												<label class="control-label" for="">邮箱：</label>
												<input type="text" placeholder="请输入邮箱" class="form-control" id="_email">
											</div>
											<div class="form-group has-success col-md-12">
												<label class="control-label" for="inputSuccess4">角色：</label>
												<select class="form-control input-group-lg" id="_roles">
													<option value="agent">坐席</option>
													<option value="qc">质检员</option>
													<option value="custom">我是自定义</option>
												</select>
											</div>
										</div>
										<div class="modal-footer">
											<a href="#" class="btn btn-default" data-dismiss="modal">取消</a>
											<a @click="addSaveBut"  href="#" class="btn btn-primary" data-dismiss="modal">保存</a>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="box-content">
							<form class="form-inline" role="form">
								<div class="form-group has-success has-feedback">
									<label class="control-label" for="inputSuccess4">工号：</label>
									<input type="text" class="form-control" placeholder="请输入工号" id="_username">
								</div>
								<input @click="queryBut(1)" type="button" class="btn btn-success" value="查询" />
							</form>
						</div>
						<br />
						<div class="box-content">
							<table class="table table-striped table-bordered responsive">
								<thead>
									<tr>
										<th>编号</th>
										<th>姓名</th>
										<th>工号</th>
										<th>手机号</th>
										<th>邮箱</th>
										<th>操作</th>
									</tr>
								</thead>
								<tbody>
									<template>
										<tr v-for="(todo,index) in todos" class="trClass">
											<td>{{index+1}}</td>
											<td v-text="todo.login_name" class="center"></td>
											<td v-text="todo.username" class="center"></td>
											<td v-text="todo.phone" class="center"></td>
											<td v-text="todo.email" class="center"></td>
											<td class="center">
												<a @click="viewBut(index)"  class="btn btn-info" href="#">
													<i class="glyphicon glyphicon-edit icon-white"></i> 编辑
												</a>
												<a  @click="removeBut(index)"  class="btn btn-danger" href="#">
													<i class="glyphicon glyphicon-trash icon-white"></i> 删除
												</a>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
							<div class="">
								<div style="width: 50%;" class="dataTables_paginate paging_bootstrap pagination pagination-small">
									<div>
										<div>
											<!--以下nav是分页代码-->
											<nav arialabel="page navigation" class="pagenavouter" id="PageNavId"></nav>
										</div>
										<div>
											<div style="float: left;">
												<strong>总条数：<a id="count">0</a></strong>
											</div>
											<div style="float: left;">
												<strong>总页数：<a id="countPage">1</a></strong>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- /content ends -->
					</div>
				</div>
			</div>
			<!--/fluid-row-->
			<hr>
			<% include ./components/footer.html %>
		</div>
		<script type="text/javascript">
			$(function() {
				var goodsVue = new Vue({
					el: "#havaTable",
					data: {
						todos: '',
						_index: 1, //指示当前选择的是第几条数据
						pageNavObj: null //分页的对象
					},
					methods: {
						checkNull:function(modelType){//检查输入不能为空
							if(null == modelType || "undefined" == typeof(modelType) || "" == modelType){
					            alert("输入不能为空");
					            throw new Error("输入有误，js终止执行");
					            return;
					        }
						},
						spliceGetStr: function(params) { //拼接get请求
							var strTemp = "";
							for(var variable in params) {
								strTemp += variable + "=" + params[variable] + "&"
							}
							if(strTemp.length > 0) {
								strTemp = strTemp.substr(0, strTemp.length - 1);
							}
							return strTemp;
						},
						getItem: function(_self, index) { //得到点击的是哪条数据,返回该条记录
							var _todosStr = JSON.stringify(_self.todos);
							var _todosArr = JSON.parse(_todosStr);
							var _item = _todosArr[index];
							return _item;
						},
						getItemId: function(_self, index) { //得到点击的是哪条数据,返回该条记录的id
							var _item = this.getItem(_self, index);
							var _itemId = _item["id"];
							return _itemId;
						},
						getDataBySession: function() { //从session中获取数据,拼接在header变量中
							var userAllInfo = $.session.get("loginUserAllInfo_tm");
							var userAllInfoJson = $.parseJSON(userAllInfo);
							var sessionId = userAllInfoJson["id"]; //返回的还是一个json对象
							var user = userAllInfoJson["user"];
							var user_id = user["id"];
							var tenant_id = user["tenant_id"];
							var _headers = {
								"sessionId": sessionId,
								"tenant_id": tenant_id,
				    			"token":"tm"
							}
							return _headers;
						},
						loadPaging: function(count, _pageNo) { //分页函数
							var pageNum = Math.ceil(count / 10); //计算总页数
							$("#count").html(count);
							$("#countPage").html(pageNum <= 0 ? 1 : pageNum);
							//下面开始分页
							this.pageNavObj = new PageNavCreate("PageNavId", {
								pageCount: pageNum, //总页数
								currentPage: _pageNo, //当前页
								perPageNum: 5, //每页按钮数
							});
							this.pageNavObj.afterClick(this.sendQuery);
						},
						sendQuery: function(_pageNo) { //发送ajax请求，获取指定条件的、带分页的数据
							var _self = this;
							var params = {
								username: $("#_username").val(),
								pageNo: _pageNo,
								pageSize: 10,
								token: "tm"
							};
							var paramsGetStr = "?" + this.spliceGetStr(params);
							//从session中获取数据，拼接到header中
							var _headers = this.getDataBySession();
							$.ajax({
								url: 'http://localhost:9001/security/user' + paramsGetStr,
								type: 'get',
								dataType: 'text',
								headers: _headers,
								success: function(_data) {
									var infoRes = $.parseJSON(_data); //返回的数据，包含时间戳等
									var infoData = infoRes["data"]; //取到data
									var count = infoRes["count"]; //取到数据总条数
									var pageNum = Math.ceil(count / 10); //计算总页数
									if(infoData == "") {
										_self.todos = '';
										alert("查询为空");
										_self.loadPaging(0, 1); //分页
									} else {
										_self.todos = infoData; //设置表格里面的数据
										console.log("获取到的数据是：" + JSON.stringify(_self.todos));
										_self.loadPaging(count, _pageNo); //分页
									}
								},
								error: function(res) {
									alert("查询失败");
								}
							});
						},
						queryBut: function(_pageNo) { //点击查询按钮
							this.sendQuery(_pageNo);
						},
						addBut: function(){//点击添加按钮，弹出框
							$('#myModal_addUser').modal('show');
						},
						addSaveBut: function(){//点击弹出框的保存按钮
							var _self = this;
							var _login_name=  $("#_login_name").val();
			    			var _username=  $("#_username").val();
			    			var _phone=  $("#_phone").val();
			    			var _email=  $("#_email").val();
			    			var _roles=  $("#_roles option:selected").val();
					    	this.checkNull(_login_name);
					    	this.checkNull(_username);
					    	this.checkNull(_phone);
					    	this.checkNull(_email);
					    	this.checkNull(_roles);
					    	var params ={
				    			login_name: _login_name,
				    			username: _username,
				    			phone: _phone,
				    			email: _email,
				    			roles: _roles
				    		};
				    		var userAllInfo=$.session.get("loginUserAllInfo_tm");
					   		var userAllInfoJson=$.parseJSON(userAllInfo);
					        var sessionId=userAllInfoJson["id"];//返回的还是一个json对象
					        var user=userAllInfoJson["user"];
					        var user_id=user["id"];
				    		var _headers= {
								"sessionId":sessionId,
								"user_id":user_id,
								"token":"tm"
							}
					    	$.ajax({
							    url:'http://localhost:9001/security/user',
							    type:'post',
							    dataType:'text',
							    data: JSON.stringify(params),
							    headers:_headers,
							    success: function(data){
							    	alert("添加成功");
							        $(".form-control").val("");//清空输入框
//							        _self.todos = _self.todos;
							    },
							    error: function(res){
							    	alert("添加失败");
					            }
							});
							
						},
						viewBut:function(index){//查看指定某一条的数据
							var _self = this;
							_self._index=index;//把查看的是哪一条记录下来
							//得到点击的是哪条数据
							var _itemId=this.getItemId(_self,index);
				    		//从session中获取数据，拼接到header中
				    		var _headers=this.getDataBySession();
//				    		_headers["user_id"]=_itemId;
				    		$.ajax({
							    url:'http://localhost:9001/security/user/back/'+_itemId,
							    type:'get',
							    dataType:'text',
							    headers:_headers,
							    success: function(_data){
							    	$('#myModal_addUser').modal('show');//让弹框显示出来
							    	var infoRes=$.parseJSON(_data);//返回的数据，包含时间戳等
						        	var infoData=infoRes["data"];//取到data
						        	if(infoData==""){
						        		alert("操作异常");
						        	}else{
						        		$("#_login_name").val(infoData["login_name"]); 
						        		$("#_username").val(infoData["username"]); 
						        		$("#_phone").val(infoData["phone"]); 
						        		$("#_email").val(infoData["email"]); 
						        		$("#viewAddress").val(infoData["address"]); 
						        	}
							    },
							    error: function(res){
					            	alert("查看失败");
					            }
							});
						},
						removeBut:function(index){//删除按钮
							var _self = this;
							//得到点击的是哪条数据
							var _itemId=this.getItemId(_self,index);
				    		//从session中获取数据，拼接到header中
				    		var _headers=this.getDataBySession();
				    		$.ajax({
							    url:'http://localhost:9001/security/user/'+_itemId,
							    type:'delete',
							    dataType:'text',
							    headers:_headers,
							    success: function(_data){
							    	alert("删除成功");
							    	_self.todos.splice(index,1);//第一个参数是下标，第二个参数是删除的数量 
							    	//取删除之前的数据条数，再减一更新上去
							    	var oldCount=$("#count").text();
							    	var oldCountPage=$("#countPage").text();
							    	var oldCountInt=parseInt(oldCount)-1;
							    	var oldCountPageInt=parseInt(oldCountPage)-1;
							    	$("#count").html(oldCountInt);
						    		$("#countPage").html(oldCountPageInt);
							    },
							    error: function(res){
					            	alert("删除失败");
					            }
							});
						}
					}
				});
			});
		</script>
	</body>

</html>